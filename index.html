<html>
	<head>
		<title>Sample "Hello, World" Application</title>
		
		<script src="/socket.io/socket.io.js"></script>
		<script type="text/javascript" src="/js/jquery-1.12.3.min.js"></script>
		<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="/js/flot/excanvas.min.js"></script><![endif]-->
		<script type="text/javascript" src="/js/flot/jquery.flot.min.js"></script>
		<script type="text/javascript" src="/js/flot/jquery.flot.time.js"></script>
		<script type="text/javascript" src="/js/flot/jquery.flot.symbol.js"></script>
		<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
		<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
		
		<style>
			#dialog label, #dialog input { display:block; }
			#dialog label { margin-top: 0.5em; }
			#dialog input, #dialog textarea { width: 95%; }
			#tabs { margin-top: 1em; }
			#tabs li .ui-icon-close { float: left; margin: 0.4em 0.2em 0 0; cursor: pointer; }
			#add_tab { cursor: pointer; }
		</style>
		
		<script>
			$(function() {
				var tabTitle = $( "#tab_title" ),
				tabTemplate = "<li><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close' role='presentation'>Remove Tab</span></li>",
				// tabContentTemplate = "<button type='button' onclick='button1(deviceSocketId)'>Start sending</button><button type='button'onclick='button2(deviceSocketId)'>Stop sending </button><button type='button' >Click Me!</button><div id='flot-placeholder1-#{href}' style='width:800px;height:200px;margin:0 auto'></div><div id='flot-placeholder2#{href}' style='width:800px;height:200px;margin:0 auto'></div><div id='flot-placeholder3-#{href}' style='width:800px;height:200px;margin:0 auto'></div>",
				tabContentTemplate = "<button type='button' onclick='button1(deviceSocketId)'>Start sending</button><button type='button' onclick='button2(deviceSocketId)'>Stop sending </button><button type='button' >Click Me!</button>",
				tabCounter = 2;
				
				var tabs = $( "#tabs" ).tabs();
				
				// modal dialog init: custom buttons and a "close" callback resetting the form inside
				var dialog = $( "#dialog" ).dialog({
					autoOpen: false,
					modal: true,
					position: { at: "center", of: "#flot-placeholder1"},
					buttons: {
						Add: function() {
							addTab();
							$( this ).dialog( "close" );
						},
						Cancel: function() {
							$( this ).dialog( "close" );
						}
					},
					close: function() {
						form[ 0 ].reset();
					}
				});
				
				// addTab form: calls addTab function on submit and closes the dialog
				var form = dialog.find( "form" ).submit(function( event ) {
					addTab();
					dialog.dialog( "close" );
					event.preventDefault();
				});
				
				// actual addTab function: adds new tab using the input from the form above
				function addTab() {
					var label = tabTitle.val() || "Tab " + tabCounter,
					id = "tabs-" + tabCounter,
					li = $( tabTemplate.replace( /#\{href\}/g, "#" + id ).replace( /#\{label\}/g, label ) ),
					//tabContentHtml = tabContent.val() || "Tab " + tabCounter + " content.";
					tabContentHtml = tabContentTemplate;
					
					var selectedDevice = devices[$("#devicesSelector").val()];
					var parsedObservableInfo = JSON.parse(selectedDevice);
					var dataFields = parsedObservableInfo.data_fields;
					var sensorName = parsedObservableInfo.sensor;
					var device = parsedObservableInfo.device;
					var dataset1;
					var dataset2;
					var dataset3;
					var totalPoints = 350;
					var updateInterval = parsedObservableInfo.resolution;
					var now = new Date().getTime();

					for (var j = 1; j<=dataFields; j++){
						tabContentHtml += "<div id='flot-placeholder" + j + "-" + id + "' style='width:800px;height:200px;margin:0 auto'></div>"
					}
					
					
					
					tabSockets[id] = $("#devicesSelector").val()
					tabData[id] = {};
					for (var j = 1; j<=dataFields; j++){
						var a = "data" + j;
						var b = "dataBuff" + j;
						tabData[id][a] = [];
						tabData[id][b] = [];
					}
					
					socket.emit("register_observer",  $("#devicesSelector").val())
					
					tabs.find( ".ui-tabs-nav" ).append( li );
					tabs.append( "<div id='" + id + "'><p>" + tabContentHtml + "</p></div>" );
					tabs.tabs( "refresh" );
					tabCounter++;
					
					initCharts (id, dataFields);
				}
				
				// addTab button: just opens the dialog
				$( "#add_tab" )
				.button()
				.click(function() {
					
					socket.emit("request_devices", function (serverDevices){
						devices = serverDevices;
						console.log("REGISTERED_DEVICES: ", serverDevices);
						
						$("#devicesSelector").find('option').remove();
						for(key in devices){
							var device = JSON.parse(devices[key]);
							console.log("DEVICE: ", device);
							$("#devicesSelector").append('<option value="'+ key+'">'+device.device+'</option>');
						}
						
						dialog.dialog( "open" );
					});
				});
				
				// close icon: removing the tab on click
				tabs.delegate( "span.ui-icon-close", "click", function() {
					var panelId = $( this ).closest( "li" ).remove().attr( "aria-controls" );
					clearInterval(tabInterval[panelId]);
					socket.emit("unregister_observer",  tabSockets[panelId]);
					delete tabSockets[panelId];
					delete tabInterval[panelId];
					delete tabData[panelId];
					$( "#" + panelId ).remove();
					tabs.tabs( "refresh" );
				});
				
				tabs.bind( "keyup", function( event ) {
					if ( event.altKey && event.keyCode === $.ui.keyCode.BACKSPACE ) {
						var panelId = tabs.find( ".ui-tabs-active" ).remove().attr( "aria-controls" );
						clearInterval(tabInterval[panelId]);
						socket.emit("unregister_observer",  tabSockets[panelId]);
						delete tabSockets[panelId];
						delete tabInterval[panelId];
						delete tabData[panelId];
						$( "#" + panelId ).remove();
						tabs.tabs( "refresh" );
					}
				});
			});
		</script>
	</head>
	<body bgcolor=white>
		
		<table border="0" cellpadding="10">
			<tr>
				<td>
					<h1>SensorReader</h1>
				</td>
			</tr>
		</table>
		
		
		<div id="dialog" title="Tab data">
			<form>
				<fieldset class="ui-helper-reset">
					<label for="tab_title">Title</label>
					<input type="text" name="tab_title" id="tab_title" value="Tab Title" class="ui-widget-content ui-corner-all">
					<label for="devicesSelector">Select device</label>
					<select name="devicesSelector" id="devicesSelector"></select>
				</fieldset>
			</form>	
		</div>
		
		<button id="add_tab">Add Tab</button>
		
		<div id="tabs">
			<ul>
			</ul>
		</div>
		
		
		
		<button type="button" onclick="button1(deviceSocketId)">Start sending</button>
		
		<button type="button" onclick="button2(deviceSocketId)">Stop sending </button>
		
		<button type="button" >Click Me!</button>
		
		<div id="flot-placeholder1" style="width:800px;height:200px;margin:0 auto"></div>
		
		<div id="flot-placeholder2" style="width:800px;height:200px;margin:0 auto"></div>
		
		<div id="flot-placeholder3" style="width:800px;height:200px;margin:0 auto"></div>

		<div id="flot-placeholder4" style="width:800px;height:200px;margin:0 auto"></div>

		<div id="flot-placeholder5" style="width:800px;height:200px;margin:0 auto"></div>

		<div id="flot-placeholder6" style="width:800px;height:200px;margin:0 auto"></div>
		
		<script type="text/javascript">
			
			var tabSockets = {};
			var tabData = {};
			var tabInterval = {};
			var params;
			var deviceSocketId;
			var startDrawing = false;
			var devices;
			var now = new Date().getTime();
			var totalPoints = 350;
			var updateInterval = 500;
			
			var options = {
				series: {

					shadowSize: 0,
					lines: {
						show: true,
						lineWidth: 1.2,
						fill: false
					}
				},
				/*xaxis: {
					mode: "time",
					tickSize: [20, "second"],
					tickFormatter: function (v, axis) {
						var date = new Date(v);
						
						if (date.getSeconds() % 20 == 0) {
							var hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
							var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
							var seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
							
							//return hours + ":" + minutes + ":" + seconds;
								return "";
							} else {
								return "";
						}
					}
				},*/
				xaxis: {
					show:false
				},
				yaxis: {
					min: -30,
					max: 30,        
					tickSize: 10,
					/*tickFormatter: function (v, axis) {
						if (v % 10 == 0) {
						return v + "%";
						} else {
						return "";
						}
					}*/
				},
				legend: {        
					labelBoxBorderColor: "#fff"
				},
				grid: {                
					backgroundColor: "#000000",
					tickColor: "#008040"
				}
			};
			
			function button1(deviceSocketId) { 
				socket.emit("start_sending", deviceSocketId);
			}
			
			function button2(deviceSocketId) { 
				socket.emit("stop_sending", deviceSocketId);
			}
			
			
			var socket = io.connect();
			
			
			socket.on("test", function (msg, socketId) {
				
				var activeTab;
				
				for (var c in tabSockets) {
					if (tabSockets[c] == socketId){
						activeTab = c;
					}
				}
				
				if (activeTab != null){
					console.log("BUFFER ARRAY", socketId);
					deviceSocketId = socketId;
					var parsed = JSON.parse(msg);
					//console.log("MSG", msg);
					if (params == null){
						params = parsed;
						device = params.device_id;
						updateInterval = params.resolution;
					}
					//Array.prototype.push.apply(data ,parsed.data[0])

					
					for (var j = 0; j < parsed.data[0].length; j++) {
						var tempTime = now += updateInterval;
						for (var i = 0; i < parsed.data.length; i++){	
							var temp = [tempTime, parsed.data[i][j]];
							tabData[activeTab]['dataBuff' + (i+1)].push(temp);
						}
					}
					
					
					/*for (index = 0; index < parsed.data[0].length; ++index) {
						
						var tempTime = now += updateInterval;
						var temp1 = [tempTime, parsed.data[0][index]];
						var temp2 = [tempTime, parsed.data[1][index]];
						var temp3 = [tempTime, parsed.data[2][index]];
						
						tabData[activeTab]['dataBuff1'].push(temp1);
						tabData[activeTab]['dataBuff2'].push(temp2);
						tabData[activeTab]['dataBuff3'].push(temp3);
						
					}*/
				}
				//updateCharts (activeTab);
				
			});

			socket.on("reconnect", function (oldSocketId, newSocketId) {
				
				var temp;
				for (var c in tabSockets) {
					if (tabSockets[c] == oldSocketId){
						temp = c;
					}
				}
					
				delete tabSockets[c];
				tabSockets[c] = newSocketId;
			});

			
			function updateCharts (activeTab, numberOfCharts){
				
				if (tabData[activeTab]['dataBuff1'].length > 0){
					
					while(tabData[activeTab]['dataBuff1'].length > 500/updateInterval){

						for (var j = 1; j <= numberOfCharts; j++) {
							tabData[activeTab]['data' + j]
								.push(tabData[activeTab]['dataBuff' + j].shift());
							tabData[activeTab]['data' + j].shift();
						}

						//tabData[activeTab]['data1'].push(tabData[activeTab]['dataBuff1'].shift());
						//tabData[activeTab]['data2'].push(tabData[activeTab]['dataBuff2'].shift());
						//tabData[activeTab]['data3'].push(tabData[activeTab]['dataBuff3'].shift());
					}
					
					console.log("BUFFER LEN", tabData[activeTab]['dataBuff1'].length);
					
					/*while(tabData[activeTab]['data1'].length > totalPoints){

						for (var j = 1; j <= numberOfCharts; j++) {
							tabData[activeTab]['data' + j].shift();
						}
						//tabData[activeTab]['data1'].shift();
						//tabData[activeTab]['data2'].shift();
						//tabData[activeTab]['data3'].shift();
					}*/
					
					console.log("ARRAY", tabData[activeTab]['data1'].length);
					
					/*dataset1 = [
					{ data: tabData[activeTab]['data1'], color: "#00FF00" }
					];
					dataset2 = [
					{ data: tabData[activeTab]['data2'], color: "#00FF00" }
					];
					dataset3 = [
					{ data: tabData[activeTab]['data3'], color: "#00FF00" }
					];*/

					for (var j = 1; j <= numberOfCharts; j++) {
						var plot = $.plot($("#flot-placeholder"+ j +"-" + activeTab)
							, [{ data: tabData[activeTab]['data' + j], color: "#00FF00" }]
							, options);
						plot.draw();
					}
					
					//$.plot($("#flot-placeholder1-" + activeTab), dataset1, options)
					//$.plot($("#flot-placeholder2-" + activeTab), dataset2, options)
					//$.plot($("#flot-placeholder3-" + activeTab), dataset3, options)
				}
			}
			
			function initCharts (activeTab, numberOfCharts){
				if (activeTab != null){
					while (tabData[activeTab]['data1'].length < totalPoints) {
						//now = new Date().getTime();
						var temp = [now += updateInterval, 0];
						//tabData[activeTab]['data1'].push(temp);
						//tabData[activeTab]['data2'].push(temp);
						//tabData[activeTab]['data3'].push(temp);
					
						for (var j = 0; j < numberOfCharts; j++) {
							tabData[activeTab]['data' + (j+1)].push(temp);
						}
					
					}
					
					/*dataset1 = [
					{ data: tabData[activeTab]['data1'], color: "#00FF00" }
					];
					dataset2 = [
					{ data: tabData[activeTab]['data2'], color: "#00FF00" }
					];
					dataset3 = [
					{ data: tabData[activeTab]['data3'], color: "#00FF00" }
					];*/
					
					for (var j = 0; j < numberOfCharts; j++) {
						$.plot($("#flot-placeholder"+ (j + 1) +"-" + activeTab)
							, [{ data: tabData[activeTab]['data' + (j + 1)], color: "#00FF00" }]
							, options).draw();
					}

					
					//$.plot($("#flot-placeholder1-" + activeTab), dataset1, options);
					//$.plot($("#flot-placeholder2-" + activeTab), dataset2, options);
					//$.plot($("#flot-placeholder3-" + activeTab), dataset3, options);
					
					tabInterval[activeTab] = setInterval(updateCharts, 200, activeTab, numberOfCharts);
					console.log("TAB INTERVAL: ", tabInterval[activeTab]);
				}
			}
		</script>  
	</body>
</html>								
